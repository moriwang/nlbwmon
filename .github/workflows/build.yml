name: Build nlbwmon for OpenWrt

on:
  push:
    branches: [ 'debug-*' ]
  pull_request:
    branches: [ ]
  workflow_dispatch:  # 允许手动触发

jobs:
  build:
    name: Build for ${{ matrix.target }}
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          # MediaTek MT7981/MT7986 (如 RAX3000M, AX6000 等)
          - target: mediatek/filogic
            arch: aarch64_cortex-a53
            openwrt_version: "24.10.0"

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up build environment
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            clang \
            flex \
            bison \
            g++ \
            gawk \
            gcc-multilib \
            gettext \
            git \
            libncurses5-dev \
            libssl-dev \
            python3-setuptools \
            rsync \
            unzip \
            zlib1g-dev \
            file \
            wget \
            curl \
            zstd

      - name: Download OpenWrt SDK
        run: |
          SDK_URL="https://downloads.openwrt.org/releases/${{ matrix.openwrt_version }}/targets/${{ matrix.target }}/openwrt-sdk-${{ matrix.openwrt_version }}-$(echo ${{ matrix.target }} | tr '/' '-')_gcc-13.3.0_musl.Linux-x86_64.tar.zst"
          
          echo "Downloading SDK from: $SDK_URL"
          wget -q "$SDK_URL" -O sdk.tar.zst
          
          echo "Extracting SDK..."
          tar --zstd -xf sdk.tar.zst
          
          SDK_DIR=$(ls -d openwrt-sdk-* | head -1)
          echo "SDK_DIR=$SDK_DIR" >> $GITHUB_ENV
          echo "SDK extracted to: $SDK_DIR"

      - name: Prepare package
        run: |
          # 创建包目录结构
          mkdir -p $SDK_DIR/package/nlbwmon/src
          mkdir -p $SDK_DIR/package/nlbwmon/files
          
          # 复制源文件
          cp *.c *.h CMakeLists.txt protocols.txt $SDK_DIR/package/nlbwmon/src/
          
          # 复制配置文件
          cp files/* $SDK_DIR/package/nlbwmon/files/
          
          # 创建 Makefile
          cat > $SDK_DIR/package/nlbwmon/Makefile <<'EOF'
          include $(TOPDIR)/rules.mk
          
          PKG_NAME:=nlbwmon
          PKG_RELEASE:=1
          PKG_VERSION:=$(shell date +%Y.%m.%d)
          
          PKG_BUILD_DIR:=$(BUILD_DIR)/$(PKG_NAME)
          PKG_LICENSE:=ISC
          
          CMAKE_INSTALL:=1
          
          include $(INCLUDE_DIR)/package.mk
          include $(INCLUDE_DIR)/cmake.mk
          
          define Package/nlbwmon
            SECTION:=net
            CATEGORY:=Network
            DEPENDS:=+libubox +libnl-tiny +zlib +kmod-nf-conntrack-netlink
            TITLE:=Netlink based bandwidth accounting (patched)
            URL:=https://github.com/moriwang/nlbwmon
          endef
          
          define Package/nlbwmon/description
           Simple conntrack based traffic accounting with fix for
           incorrect traffic accumulation on hardware offload platforms.
          endef
          
          define Build/Prepare
          	mkdir -p $(PKG_BUILD_DIR)
          	$(CP) ./src/* $(PKG_BUILD_DIR)/
          endef
          
          CMAKE_OPTIONS += -DLIBNL_LIBRARY_TINY=ON
          # Add staging_dir include path for libnl-tiny headers
          TARGET_CFLAGS += -I$(STAGING_DIR)/usr/include/libnl-tiny
          
          define Package/nlbwmon/install
          	$(INSTALL_DIR) $(1)/usr/sbin
          	$(INSTALL_BIN) $(PKG_INSTALL_DIR)/usr/sbin/nlbwmon $(1)/usr/sbin/nlbwmon
          	$(LN) nlbwmon $(1)/usr/sbin/nlbw
          	$(INSTALL_DIR) $(1)/usr/share/nlbwmon
          	$(INSTALL_DATA) $(PKG_BUILD_DIR)/protocols.txt $(1)/usr/share/nlbwmon/protocols
          	$(INSTALL_DIR) $(1)/etc/init.d
          	$(INSTALL_BIN) ./files/nlbwmon.init $(1)/etc/init.d/nlbwmon
          	$(INSTALL_DIR) $(1)/etc/config
          	$(INSTALL_CONF) ./files/nlbwmon.config $(1)/etc/config/nlbwmon
          	$(INSTALL_DIR) $(1)/etc/hotplug.d/iface
          	$(INSTALL_BIN) ./files/nlbwmon.hotplug $(1)/etc/hotplug.d/iface/30-nlbwmon
          endef
          
          define Package/nlbwmon/conffiles
          /etc/config/nlbwmon
          /usr/share/nlbwmon/protocols
          endef
          
          $(eval $(call BuildPackage,nlbwmon))
          EOF
          
          echo "Package structure created"
          ls -la $SDK_DIR/package/nlbwmon/

      - name: Update feeds
        working-directory: ${{ env.SDK_DIR }}
        run: |
          ./scripts/feeds update -a
          ./scripts/feeds install -a

      - name: Configure and build
        working-directory: ${{ env.SDK_DIR }}
        run: |
          # 配置
          make defconfig
          
          # 先编译依赖包 libnl-tiny，确保头文件和库在 staging_dir 中
          make package/libnl-tiny/compile V=s -j$(nproc) || true
          make package/libnl-tiny/install V=s -j$(nproc) || true
          
          # 编译 nlbwmon
          make package/nlbwmon/compile V=s -j$(nproc)
          
          # 查找生成的 ipk 文件
          find bin/ -name "nlbwmon*.ipk" -type f

      - name: Organize artifacts
        run: |
          mkdir -p artifacts
          
          # 复制 ipk 文件
          find $SDK_DIR/bin/packages/ -name "nlbwmon*.ipk" -exec cp {} artifacts/ \;
          
          # 创建信息文件
          cat > artifacts/BUILD_INFO.txt <<EOF
          Build Information
          ==================
          Target: ${{ matrix.target }}
          Architecture: ${{ matrix.arch }}
          OpenWrt Version: ${{ matrix.openwrt_version }}
          Build Date: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          Git Commit: ${{ github.sha }}
          Git Branch: ${{ github.ref_name }}
          
          Installation Instructions
          ==========================
          1. Upload the .ipk file to your router:
             scp nlbwmon_*.ipk root@<router-ip>:/tmp/
          
          2. Install on router:
             opkg remove nlbwmon
             opkg install /tmp/nlbwmon_*.ipk
             /etc/init.d/nlbwmon restart
          
          3. Verify:
             nlbw -c show
          EOF
          
          ls -lh artifacts/

      - name: Prepare artifact name
        run: |
          SAFE_TARGET=$(echo "${{ matrix.target }}" | tr '/' '-')
          echo "ARTIFACT_NAME=nlbwmon-${SAFE_TARGET}-${{ matrix.arch }}" >> $GITHUB_ENV

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.ARTIFACT_NAME }}
          path: artifacts/*
          retention-days: 30

  release:
    name: Create Release
    needs: build
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: artifacts/**/*.ipk
          body: |
            ## nlbwmon with Traffic Accumulation Fix
            
            ### Changes
            - Fixed incorrect traffic accumulation causing inflated statistics
            - Properly calculates deltas instead of accumulating absolute values
            - Resolves 30x overreporting on hardware offload platforms
            
            ### Installation
            1. Download the appropriate `.ipk` file for your router architecture
            2. Upload to router: `scp nlbwmon_*.ipk root@<router-ip>:/tmp/`
            3. Install: `opkg remove nlbwmon && opkg install /tmp/nlbwmon_*.ipk`
            4. Restart: `/etc/init.d/nlbwmon restart`
            
            ### Architectures Included
            - `aarch64_cortex-a53`: MediaTek MT7981/MT7986 (RAX3000M, etc.)
            - `mipsel_24kc`: Ramips MT7621
            - `arm_cortex-a15_neon-vfpv4`: IPQ806x
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

